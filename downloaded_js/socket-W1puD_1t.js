var I=Object.defineProperty;var N=(s,e,t)=>e in s?I(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var c=(s,e,t)=>N(s,typeof e!="symbol"?e+"":e,t);import{c2 as v,b$ as O,c0 as g,a0 as A,k as y,aS as C,U as u,X as E,aV as D,i as m,$ as p}from"./index-9nzDUZpM.js";import{b as W}from"./_baseUniq-PYuWT94M.js";import{i as P}from"./_arrayIncludesWith-DM60zyun.js";import{A as T,f as R}from"./index-BLKbDCJL.js";import{c as S,s as L,g as k}from"./index-C9cC747C.js";var $=Object.prototype,b=$.hasOwnProperty;function x(s,e){return s!=null&&b.call(s,e)}function M(s,e){return s!=null&&v(s,e,x)}function _(s,e){return e=typeof e=="function"?e:void 0,s&&s.length?W(s,void 0,e):[]}const U=g({id:"noticeList",state:()=>({noticeObj:{},cacheTimestamps:{}}),actions:{isExpired(s){const e=this.cacheTimestamps[s];if(!e)return!0;const t=Date.now(),o=2*60*1e3;return t-e>o},cleanExpiredCache(){const s=[];for(const e in this.noticeObj)this.isExpired(e)&&s.push(e);s.forEach(e=>{delete this.noticeObj[e],delete this.cacheTimestamps[e]})},save(s,e,t,o){const i=`${s}.${e}.${t}`;let n={...this.noticeObj};if(M(n,i)){let r=A(n,i);r=_([...o,...r],P),n[i]=r}else n[i]=o;this.cacheTimestamps[i]=Date.now(),this.noticeObj={...n}},clearAllCache(){this.noticeObj={},this.cacheTimestamps={}}}});function F(){return U(O)}const h=y(),J=F(),X=new D,q=new T;let z=`ws://${window.location.hostname}:8888`,w=15*1e3;class G{constructor(e,t){c(this,"emsId");c(this,"keyless");c(this,"p",Promise.resolve());c(this,"socket");c(this,"onceFunArr",m([]));c(this,"wsData",m({menu:{},rtv:[],log:[],cfg:0,expire:{},log_data:[],ctl:[],policy:{}}));c(this,"timer",null);c(this,"MRDA",{});c(this,"shouldReconnect",!0);c(this,"keep",()=>{clearInterval(this.timer),this.timer=setInterval(()=>{let e=new Uint8Array([9]);this.socket.send(e)},30*1e3)});c(this,"onmessage",e=>{let t=e.data;if(!(t instanceof Blob)){if(t=JSON.parse(t),R(this.onceFunArr,(o,i)=>{o(t)&&this.onceFunArr.slice(i,i+1)}),t.func==="rtv"&&(t.data=t.data.map(o=>({...o,value:S(o.value,2)}))),t.func==="log_data"){this.wsData[t.func]=[...t.data,...this.wsData[t.func]];return}t.func==="expire"&&(t.data={...t.data,his_data:L(t.data.his_data).map(o=>{const i=Object.keys(o).find(n=>!isNaN(Number(n)))||"";return{...o,[i]:S(o[i],2)}})}),this.wsData[t.func]=t.data,t.func==="log"&&this.wsData.log.length&&J.save(this.emsId,p().startOf("date").valueOf(),p().endOf("date").valueOf(),t.data),t.func==="refresh"&&this.onRefresh(),t.func==="timezone"&&localStorage.setItem("timezone",t.data)}});c(this,"onRefresh",()=>{window.sessionStorage.setItem("autoRefresh",this.emsId),location.reload()});c(this,"close",()=>{this.shouldReconnect=!1,this.socket.close()});c(this,"onclose",()=>{clearInterval(this.timer),this.shouldReconnect&&setTimeout(()=>{this.connect(),this.p.then(()=>{u(this.MRDA,(e,t)=>{this.send(e)})})},w)});c(this,"onerror",e=>{setTimeout(()=>{this.connect()},w)});this.emsId=e,this.keyless=t,this.connect()}connect(){this.p=new Promise((e,t)=>{let i=0;const n=()=>{const a=new WebSocket(`${z}/${this.emsId}?${this.keyless}`);this.socket=a,a.onopen=this.onopen(e),a.onmessage=this.onmessage,a.onclose=this.onclose,this.keep();const r=3*1e3;setTimeout(()=>{a.readyState===WebSocket.CONNECTING&&(console.warn("WebSocket 一直处于 CONNECTING 状态，可能已挂起，尝试重连"),a.close(),this.shouldReconnect=!1,i++,i<3?n():t())},r)};n()})}onopen(e){return()=>{this.shouldReconnect=!0,this.socket.onerror=this.onerror,e()}}send(e){return new Promise((t,o)=>{const i=this.socket,n={...e},a=n.funcAck||n.func;delete n.funcAck,i.readyState===WebSocket.OPEN?(this.MRDA[n.func]=n,i.send(JSON.stringify(n)),this.onceFunArr.unshift(r=>{var f;let l=r.func,d=a;return n.id&&((f=r==null?void 0:r.data)!=null&&f.id)&&(l+=r.data.id,d+=n.id),l===d&&t(r),l===d})):(o(),console.error("无法发送消息，因为连接未打开或正在关闭"))})}sendtimeZone(){return B.call(this)}sendMenu(){return this.send({func:"menu"})}sendRtv(e){return this.send({func:"rtv",period:0,ids:e})}sendExpire(e){let t=JSON.stringify((e==null?void 0:e.ids)||[]);return this.send({func:"expire",...e,begin:Number(e.begin)+k(),end:Number(e.end)+k(),ids:t})}sendExport(e){let t=JSON.stringify((e==null?void 0:e.ids)||[]);return this.send({func:"export",...e,ids:t})}sendLog(e){return this.send({func:"log",...e})}sendCfg(e){return this.send({func:"cfg",...e})}clearRtv(){this.wsData.rtv=[]}sendCtl(){return this.send({func:"ctl"})}sendCmd(e){return this.send({func:"cmd",funcAck:"cmd_ack",...e})}sendPolicy(e){return this.send({func:"policy",...e})}}const Z=g({id:"ws",state:()=>({emsIdList:{},socket:{},menuP:{},keyless:""}),getters:{},actions:{connectionWS(){var s,e;(e=(s=h.powerStation)==null?void 0:s[0])!=null&&e.userId&&(this.keyless=q.encrypt(`${h.powerStation[0].userId};${X.get("sa-token")};${localStorage.getItem("locale")}`),u(h.powerStation,t=>{this.setEmsId(t.emsId)}))},updateConnectionWS(){const s=h.powerStation;u(this.emsIdList,(e,t)=>{E(s,{emsId:t})||(this.socket[t].close(),delete this.emsIdList[t],delete this.socket[t],delete this.menuP[t])}),this.connectionWS()},setEmsId(s){if(this.emsIdList[s])return this.menuP[s];this.emsIdList[s]=!0,this.menuP[s]=this.initWS(s).p.then(()=>(this.socket[s].sendtimeZone(),this.socket[s].send({func:"menu"})))},initWS(s){const e=new G(s,this.keyless);return this.socket[s]=e,e},clearConnectionWS(){u(this.emsIdList,(s,e)=>{this.socket[e].close(),delete this.emsIdList[e],delete this.socket[e],delete this.menuP[e]})}}}),B=C(function(){this.send({func:"timezone"})});function ee(){return Z(O)}export{F as a,_ as b,M as h,ee as u};
